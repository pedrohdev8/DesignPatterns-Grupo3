name: DevSecOps Pipeline (N8n VPS Deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite rodar manualmente clicando num bot√£o no GitHub

jobs:
  ##########################################
  # 1. SECURITY - An√°lise Est√°tica
  ##########################################
  security_scan:
    name: üîç SAST & Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect Secrets (Gitleaks)
        # Usando a vers√£o mais recente e recomendada
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ##########################################
  # 2. DEPLOY - Atualiza√ß√£o na VPS via SSH
  ##########################################
  deploy:
    name: ‚òÅÔ∏è Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    needs: security_scan
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 22
          script: |
            # 1. Navegar para a pasta do projeto na VPS
            # (Crie essa pasta na VPS antes: mkdir -p /opt/n8n-educacional)
            cd /opt/n8n-educacional
            
            # 2. Atualizar o c√≥digo (Ex: docker-compose.yml ou scripts python auxiliares)
            # Se voc√™ ainda n√£o clonou o repo l√°, fa√ßa 'git clone' na primeira vez manualmente
            git pull origin main
            
            # 3. Criar/Atualizar arquivo .env com as secrets do GitHub
            echo "${{ secrets.ENV_FILE_CONTENT }}" > .env
            
            # 4. Reiniciar os containers do Docker
            # Isso baixa a imagem oficial mais nova do n8n e recria o container
            docker compose pull
            docker compose up -d --remove-orphans
            
            # 5. Limpeza de imagens antigas para economizar espa√ßo na VPS
            docker image prune -f


            name: Deploy n8n Workflow

on:
  push:
    branches:
      - main  # Altere para a branch principal que voc√™ usa
    paths:
      - 'workflow.json' # Altere para o nome do arquivo do seu fluxo (por exemplo, AgenteIAFracao.json)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: üöÄ Fazer o Deploy do Workflow no n8n
        env:
          N8N_URL: ${{ secrets.N8N_URL }} 
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }} 
          WORKFLOW_ID: fN5LdMrxWWyJbkbC 
          WORKFLOW_FILE: workflow.json 

        run: |
          # 1. Obter o conte√∫do do seu fluxo de trabalho JSON
          WORKFLOW_DATA=$(cat $WORKFLOW_FILE | tr -d '\n')
          
          # 2. Criar o payload para a API, incluindo o ID e a tag 'active: true'
          #    IMPORTANTE: O 'nodes' deve ser uma string, por isso √© crucial escapar as aspas.
          #    No n8n, a API de atualiza√ß√£o (PUT) precisa de um corpo espec√≠fico:
          #    { "data": { "nodes": [...] }, "active": true }
          
          PAYLOAD="{ \"data\": $WORKFLOW_DATA, \"active\": true }"
          
          # 3. Fazer a chamada PUT para atualizar o fluxo de trabalho existente
          #    O header 'X-N8N-API-KEY' √© a forma padr√£o de autenticar com a chave API
          curl -X PUT \
            -H "Content-Type: application/json" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -d "$PAYLOAD" \
            $N8N_URL/api/v1/workflows/$WORKFLOW_ID
          
          echo "Workflow com ID $WORKFLOW_ID implantado e ativado com sucesso!"

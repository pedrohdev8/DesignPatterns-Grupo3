name: DevSecOps Pipeline (Agente Educacional N8n)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  ##########################################
  # 1. SOURCE - An√°lise Est√°tica (SAST)
  ##########################################
  source:
    name: üîç Source Analysis (Semgrep & Gitleaks)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep (SAST)
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/owasp-top-ten"

      - name: Detect Secrets (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --verbose

  ##########################################
  # 2. BUILD - Instala√ß√£o e Escaneamento
  ##########################################
  build:
    name: üß± Build & Dependency Scans (N8n + APIs)
    runs-on: ubuntu-latest
    needs: source

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js (para N8n e integra√ß√µes)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install
          npm audit --production

      - name: Run Trivy - Code & Dependencies Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'

      - name: Build Docker image (N8n + API Gateway)
        run: docker build -t agente-educacional-n8n:latest .

      - name: Run Trivy on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'agente-educacional-n8n:latest'
          format: 'table'
          exit-code: '0'
          severity: 'HIGH,CRITICAL'

      - name: Save Docker image
        run: docker save agente-educacional-n8n:latest -o agente-educacional-n8n.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: agente-educacional-n8n-image
          path: agente-educacional-n8n.tar

  ##########################################
  # 3. TEST - Dynamic Security Tests (DAST)
  ##########################################
  test:
    name: üß™ Dynamic Security Tests (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: agente-educacional-n8n-image
          path: .

      - name: Load Docker image
        run: docker load -i agente-educacional-n8n.tar

      - name: Start N8n container (simula√ß√£o do ambiente Hostinger)
        run: |
          docker run -d -p 5678:5678 --name agente-educacional-n8n \
            -e SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            -e SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
            -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            agente-educacional-n8n:latest

      - name: Wait for N8n to start
        run: |
          for i in {1..10}; do
            if curl -s http://localhost:5678 > /dev/null; then
              echo "‚úÖ N8n est√° respondendo!"
              exit 0
            fi
            echo "Tentativa $i de 10: aguardando N8n..."
            sleep 5
          done
          echo "‚ùå N8n n√£o iniciou a tempo"
          docker logs agente-educacional-n8n
          exit 1

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: 'http://localhost:5678'
          cmd_options: '-J zap_report.json -r zap_report.html'
        continue-on-error: true

      - name: Stop container
        if: always()
        run: |
          docker stop agente-educacional-n8n || true
          docker rm agente-educacional-n8n || true

  ##########################################
  # 4. RELEASE - Valida√ß√£o
  ##########################################
  release:
    name: üöÄ Release Validation
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://seu-agente.hostinger.com
    steps:
      - name: Validate Release
        run: echo "‚úÖ Testes e verifica√ß√µes finalizadas ‚Äî pronto para deploy!"

  ##########################################
  # 5. DEPLOY - Publica√ß√£o no Servidor Hostinger
  ##########################################
  deploy:
    name: ‚òÅÔ∏è Deploy to Hostinger (FTP ou Docker)
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via FTP (Hostinger Web)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./dist
          server-dir: /public_html/

      # Caso utilize VPS na Hostinger (Docker):
      # - name: Deploy via SSH e Docker
      #   uses: appleboy/ssh-action@v0.1.10
      #   with:
      #     host: ${{ secrets.HOSTINGER_SSH_HOST }}
      #     username: ${{ secrets.HOSTINGER_SSH_USER }}
      #     key: ${{ secrets.HOSTINGER_SSH_KEY }}
      #     script: |
      #       docker stop agente-educacional-n8n || true
      #       docker rm agente-educacional-n8n || true
      #       docker load -i agente-educacional-n8n.tar
      #       docker run -d -p 5678:5678 agente-educacional-n8n:latest

name: DevSecOps Pipeline (N8n VPS Deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite rodar manualmente clicando num bot√£o no GitHub

jobs:
  ##########################################
  # 1. SECURITY - An√°lise Est√°tica
  ##########################################
  security_scan:
    name: üîç SAST & Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect Secrets (Gitleaks)
        # Usando a vers√£o mais recente e recomendada
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ##########################################
  # 2. DEPLOY - Atualiza√ß√£o na VPS via SSH
  ##########################################
  deploy:
    name: ‚òÅÔ∏è Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    needs: security_scan
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 22
          script: |
            # 1. Navegar para a pasta do projeto na VPS
            # (Crie essa pasta na VPS antes: mkdir -p /opt/n8n-educacional)
            cd /opt/n8n-educacional
            
            # 2. Atualizar o c√≥digo (Ex: docker-compose.yml ou scripts python auxiliares)
            # Se voc√™ ainda n√£o clonou o repo l√°, fa√ßa 'git clone' na primeira vez manualmente
            git pull origin main
            
            # 3. Criar/Atualizar arquivo .env com as secrets do GitHub
            echo "${{ secrets.ENV_FILE_CONTENT }}" > .env
            
            # 4. Reiniciar os containers do Docker
            # Isso baixa a imagem oficial mais nova do n8n e recria o container
            docker compose pull
            docker compose up -d --remove-orphans
            
            # 5. Limpeza de imagens antigas para economizar espa√ßo na VPS
            docker image prune -f
